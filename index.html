<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>busytex</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/xterm@3.8.0/dist/xterm.css"
    />
    <style>
        body {
            height: 100vh;
            padding: 0; 
            margin: 0;
        }

        #fileupload {
            display: none;
        }

        #viewer {
            width: 50%;
        }

        #editor {
            width: 50%; 
            border: 1px solid grey;
        }

        #terminal {
            width: 100%; 
            height: 70%;
        }

        #status {
            width: 100%;
            height: 30%;
            padding: 5px;
            margin: 0;
            resize: none;
            box-sizing: border-box;
        }

        #pdfpreview {
            width: 99%;
            height: 100%;
        }
    </style>
  </head>
  <body>
    <div style="display: flex; height: 50%">
      <div id="editor"></div>
      <div id="viewer">
        <iframe id="pdfpreview"></iframe>
        <img hidden id="imgpreview"></img>
      </div>
    </div>
    <div style="display: flex; flex-direction: column; height: 50%">
      <div id="terminal"></div>
      <textarea
        name="status"
        id="status"
        cols="1"
        rows="1"
      ></textarea>
      <input type="file" id="fileupload">
    </div>

    <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
    <script src="/busytex.pipeline.js"></script>

    <template id="helloworld">JVBERi0xLjcKCjEgMCBvYmogICUgZW50cnkgcG9pbnQKPDwKICAvVHlwZSAvQ2F0YWxvZwogIC9QYWdlcyAyIDAgUgo+PgplbmRvYmoKCjIgMCBvYmoKPDwKICAvVHlwZSAvUGFnZXMKICAvTWVkaWFCb3ggWyAwIDAgMjAwIDIwMCBdCiAgL0NvdW50IDEKICAvS2lkcyBbIDMgMCBSIF0KPj4KZW5kb2JqCgozIDAgb2JqCjw8CiAgL1R5cGUgL1BhZ2UKICAvUGFyZW50IDIgMCBSCiAgL1Jlc291cmNlcyA8PAogICAgL0ZvbnQgPDwKICAgICAgL0YxIDQgMCBSIAogICAgPj4KICA+PgogIC9Db250ZW50cyA1IDAgUgo+PgplbmRvYmoKCjQgMCBvYmoKPDwKICAvVHlwZSAvRm9udAogIC9TdWJ0eXBlIC9UeXBlMQogIC9CYXNlRm9udCAvVGltZXMtUm9tYW4KPj4KZW5kb2JqCgo1IDAgb2JqICAlIHBhZ2UgY29udGVudAo8PAogIC9MZW5ndGggNDQKPj4Kc3RyZWFtCkJUCjcwIDUwIFRECi9GMSAxMiBUZgooSGVsbG8sIHdvcmxkISkgVGoKRVQKZW5kc3RyZWFtCmVuZG9iagoKeHJlZgowIDYKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAwMDEwIDAwMDAwIG4gCjAwMDAwMDAwNzkgMDAwMDAgbiAKMDAwMDAwMDE3MyAwMDAwMCBuIAowMDAwMDAwMzAxIDAwMDAwIG4gCjAwMDAwMDAzODAgMDAwMDAgbiAKdHJhaWxlcgo8PAogIC9TaXplIDYKICAvUm9vdCAxIDAgUgo+PgpzdGFydHhyZWYKNDkyCiUlRU9G</template>
    <script type="module">

    import { Shell } from '/shell.js'

    function modularized_module(thisProgram, preRun, println)
    {
        const Module =
        {
            noInitialRun : true,

            thisProgram : thisProgram,

            preRun : [preRun],
            
            print(text) 
            {
                Module.setStatus('stdout: ' + (arguments.length > 1 ?  Array.prototype.slice.call(arguments).join(' ') : text));
            },

            printErr(text)
            {
                Module.setStatus('stderr: ' + (arguments.length > 1 ?  Array.prototype.slice.call(arguments).join(' ') : text));
            },
            
            setStatus(text)
            {
                println((this.statusPrefix || '') + text);
            },
            
            monitorRunDependencies(left)
            {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
            },
            
            totalDependencies: 0,
        };
        return Module;
    }
    
    var cur_line = '';
    const onkey = async (key, ev) =>
    {
        const ok = 'ok!';
        if(ev.keyCode == 8)
        {
            if(cur_line.length > 0)
            {
                cur_line = cur_line.slice(0, cur_line.length - 1);
                window.terminal.write('\b \b');
            }
        }
        else if(ev.keyCode == 13)
        {
            window.terminal.println();
            const [cmd, arg] = cur_line.split(' ');
            try
            {
                if (cmd == '')
                {
                }
                else if(cmd == 'clear')
                {
                    shell.clear();
                }
                else if(cmd == 'help')
                {
                    window.terminal.println(shell.help().join(' '));
                }
                else if(cmd == 'download')
                {
                    shell.download(arg);
                    window.terminal.println(ok);
                }
                else if(cmd == 'upload')
                {
                    window.terminal.println(await shell.upload(arg));
                }
                else if(cmd == 'latexmk')
                {
                    await shell.latexmk(arg);
                }
                else if(cmd == 'pwd')
                {
                    window.terminal.println(shell.pwd());
                }
                else if(cmd == 'ls')
                {
                    const res = shell.ls(arg);
                    if(res.length > 0)
                        window.terminal.println(res.join(' '));
                }
                else if(cmd == 'mkdir')
                {
                    shell.mkdir(arg);
                }
                else if(cmd == 'cd')
                {
                    shell.cd(arg);
                }
                else if(cmd == 'clone')
                {
                    await shell.clone(arg);
                }
                else if(cmd == 'push')
                {
                    await shell.push(arg);
                    window.terminal.println(ok);
                }
                else if(cmd == 'open')
                {
                    shell.open(arg);
                }
                else if(cmd == 'save')
                {
                    shell.save(arg, window.editor.getModel().getValue());
                }
                else
                {
                    window.terminal.println(cmd + ': command not found');
                }
            }
            catch(err)
            {
                window.terminal.println('Error: ' + err.message);
            }
            window.terminal.prompt();
            cur_line = '';
        }
        else
        {
            cur_line += key;
            window.terminal.write(key);
        }
    };

    require.config({
        paths: {
          vs: 'https://unpkg.com/monaco-editor@latest/min/vs',
          xterm: 'https://unpkg.com/xterm@3.8.0/dist'
        }
      })

      // Before loading vs/editor/editor.main, define a global MonacoEnvironment that overwrites
      // the default worker url location (used when creating WebWorkers). The problem here is that
      // HTML5 does not allow cross-domain web workers, so we need to proxy the instantiation of
      // a web worker through a same-domain script
      window.MonacoEnvironment = {
        getWorkerUrl: function (workerId, label) {
          return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
              self.MonacoEnvironment = {
                baseUrl: 'https://unpkg.com/monaco-editor@latest/min/'
              };
              importScripts('https://unpkg.com/monaco-editor@latest/min/vs/base/worker/workerMain.js');`)}`
        }
      }

      require([
        'vs/editor/editor.main',
        'xterm/xterm',
        'xterm/addons/fit/fit',
        './dist/emscriptenfs',
      ], async function (editor, Terminal, fit, emscriptenfs) {

        window.editor = editor.editor.create(document.getElementById('editor'), {
          theme: 'vs-dark'
        })

        Terminal.applyAddon(fit)
        window.terminal = new Terminal()
        window.terminal.open(document.getElementById('terminal'))
        window.terminal.on('key', onkey);
        window.terminal.prompt = () => window.terminal.write('\x1B[1;3;31memscripten\x1B[0m:' + new Shell(typeof(window.shell.FS) == 'undefined' ? null : window.shell.FS, window.terminal).pwd(true) + '$ ');
        window.terminal.println = line => window.terminal.write((line || '') + '\r\n');
        window.println = text =>
        {
            let statusElement = document.getElementById('status');
            const ansi_reset_sequence = '\x1bc';
            if(text == ansi_reset_sequence)
                statusElement.value = '';
            else
            {
                statusElement.value += text;
                statusElement.value += '\n';
                statusElement.scrollTop = statusElement.scrollHeight;
            }
        };
        
        const Module = await emscriptenfs(modularized_module(null, () =>  {}, window.println));

        const busytex_js = '/dist/busytex.js', busytex_wasm = '/dist/busytex.wasm';
        const busytex_worker_js = '/busytex.worker.js', busytex_pipeline_js = '/busytex.pipeline.js';
        const texlive_js = ['/dist/texlive-basic.js'];//, '/dist/texlive-latex-recommended.js', '/dist/texlive-latex-extra.js'];
        const texmf_local = ['./texmf'];

        window.compiler = new Worker(busytex_worker_js);
        window.compiler.onmessage = e =>
        {
            const {pdf, log} = e.data;
            if(pdf)
            {
                window.shell.toc();
                shell.FS.writeFile(shell.pdf_path, pdf);
                shell.open(shell.pdf_path, pdf);
            }
            else if(log)
            {
                window.println(log);
            }
        }
        window.compiler.postMessage({busytex_js : busytex_js, busytex_wasm : busytex_wasm, texlive_js : texlive_js, texmf_local : texmf_local});
              
        const ui = {
            imgpreview : document.getElementById('imgpreview'),
            pdfpreview : document.getElementById('pdfpreview'),
            fileupload : document.getElementById('fileupload')
        };
        const pdf_helloworld = atob(document.getElementById('helloworld').innerHTML);

        window.shell = new Shell(Module.FS, window.terminal, window.compiler, window.location.hash, window.location.search, pdf_helloworld, ui);
        window.editor.layout()
        window.terminal.fit()
        window.onresize = () =>
        {
            window.editor.layout()
            window.terminal.fit()
        };
        await window.shell.run();
      })
    </script>
  </body>
</html>

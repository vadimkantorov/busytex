<html><body style="width: 100%; height: 100%">

<div><iframe style="width: 100%; height:50%" id="preview"></iframe></div>
<div><textarea style="width: 100%; height: 50%" id="status"></textarea></div>

<script>

const basename = name => {
  var lastSlash = name.lastIndexOf('/');
  var lastDot = name.lastIndexOf('.');
  if (lastDot === -1) {
    return name;
  }
  if (lastSlash < lastDot) {
    return name.slice(0, lastDot);
  }
  return name;
};

const splitPath = name => {
  var lastSlash = name.lastIndexOf('/');
  if (lastSlash === -1) {
    return ['', name];
  }
  // trim trailing slashes from the head part
  var i;
  for (i = lastSlash - 1; i > 0 && name.charAt(i) === '/'; i--) {
    // no-op
  }
  return [name.slice(0, i), name.slice(lastSlash + 1)];
};

let statusElement = document.getElementById('status');
let previewElement = document.getElementById('preview');

const texliveRoot = '/texlive';
const xelatexFmtPath = '/xelatex.fmt';
const sourcePath = '/home/web_user/source.tex';
const outputPath = '/home/web_user/source.xdv';
const texliveCnf = '/texmf.cnf';
const xelatex = '/xelatex';

ls = path => console.log(Object.keys(FS.lookupPath(path).node.contents));

function main(Module)
{
    FS.chdir('/home/web_user');
    FS.writeFile(xelatex, '', {encoding: 'utf-8'});

    FS.writeFile(sourcePath, '\\documentclass{article}\\begin{document}Hello, world!\\end{document}', {encoding: 'utf-8'}); 

    //const texMfCnfContent = `
    //  TEXDIR = ${texliveRoot}
    //  TEXMFDIST = ${texliveRoot}/texmf-dist
    //  TEXMFLOCAL = ${texliveRoot}/texmf-local
    //  TEXMFCONFIG = ${texliveRoot}/texmf-config
    //  TEXMFSYSCONFIG = ${texliveRoot}/texmf-config
    //  TEXMFVAR = /home/web_user
    //  TEXMFOUTPUT = /home/web_user
    //  TEXMFSYSVAR = /home/web_user
    //  TEXMF = {!!$TEXMFDIST,!!$TEXMFLOCAL,!!TEXMFCONFIG}`;
    //FS.writeFile(texliveCnf, texMfCnfContent, {encoding: 'utf-8'});
    //ENV['KPATHSEA_DEBUG'] = '1';
    
    
    ls('.');
    //ENV.TEXMFDIST = '/texlive/texmf-dist:';
    //ENV['FC_DEBUG'] = '1';
    //ENV.FONTCONFIG_PATH = '/';
    //ENVFONTCONFIG_FILE = 'texlive-fontconfig.conf';
    
    Module.callMain(['--interaction=nonstopmode','--recorder', '--no-pdf', '--fmt=' + xelatexFmtPath, '--output-directory=/home/web_user', '--halt-on-error', '--jobname=myjobname.dvi', sourcePath]);

    ls('.');
    
    //const xdvData = FS.readFile(outputPath, {encoding: 'binary'});
    //console.log(xdvData);
    //previewElement.src = URL.createObjectURL(new Blob([pdfData], {type: 'application/pdf'}));
};

var Module = 
{
    thisProgram : xelatex, 

    noInitialRun : true,

    preRun : [(() =>
    {
        ENV.TEXMFDIST = '/texlive/texmf-dist:';
        //ENV['FC_DEBUG'] = '1';
        ENV.FONTCONFIG_PATH = '/fontconfig';
        ENV.FONTCONFIG_FILE = 'texlive-fontconfig.conf';
    })],

    onRuntimeInitialized()
    {
        main(Module);
    },
    
    print(text) 
    {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        console.log(text);
    },

    printErr(text)
    {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        console.error(text);
    },
    
    setStatus(text)
    {
        statusElement.value += (this.statusPrefix || '') + text + '\n';
        statusElement.scrollTop = statusElement.scrollHeight;
    },
    
    monitorRunDependencies(left)
    {
        this.totalDependencies = Math.max(this.totalDependencies, left);
        Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
    },
    
    totalDependencies: 0,
};
Module.setStatus('Downloading Emscripten...');
window.onerror = () => { Module.statusPrefix = '[post-exception] ';};
</script>

</script>
<script async type="text/javascript" src="texlive.js"></script>
<script async type="text/javascript" src="xelatex.js"></script>

</body></html>

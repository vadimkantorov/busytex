<html><body style="width: 100%; height: 100%; overflow: hidden">

<div><iframe style="width: 98%; height:50%" id="preview"></iframe></div>
<div><textarea style="width: 98%; height: 50%" id="status"></textarea></div>

<script>

let statusElement = document.getElementById('status');
let previewElement = document.getElementById('preview');

const texliveRoot = '/texlive';
const xelatexFmtPath = '/xelatex.fmt';
const sourcePath = '/home/web_user/source.tex';
const texliveCnf = '/texmf.cnf';
const xelatex = './xetex';
const dvipdfmx = './dvipdfmx';
const busytex = '/bin/busytex';

ls = path => console.log(Object.keys(FS.lookupPath(path).node.contents));

function main(Module)
{
    FS.chdir('/home/web_user');

    //const texMfCnfContent = `
    //  TEXDIR = ${texliveRoot}
    //  TEXMFDIST = ${texliveRoot}/texmf-dist
    //  TEXMFLOCAL = ${texliveRoot}/texmf-local
    //  TEXMFCONFIG = ${texliveRoot}/texmf-config
    //  TEXMFSYSCONFIG = ${texliveRoot}/texmf-config
    //  TEXMFVAR = /home/web_user
    //  TEXMFOUTPUT = /home/web_user
    //  TEXMFSYSVAR = /home/web_user
    //  TEXMF = {!!$TEXMFDIST,!!$TEXMFLOCAL,!!TEXMFCONFIG}`;
    //FS.writeFile(texliveCnf, texMfCnfContent, {encoding: 'utf-8'});
    //ENV['KPATHSEA_DEBUG'] = '1';

    FS.writeFile(sourcePath, '\\documentclass{article}\\begin{document}Hello, world!\\end{document}', {encoding: 'utf-8'}); 
    Module.callMain(['xetex', '--interaction=nonstopmode', '--no-pdf', '--fmt=' + xelatexFmtPath, '--output-directory=/home/web_user', '--halt-on-error',  sourcePath]);
    ls('.');
    //Module.callMain(['dvipdfmx', 'myjobname.dvi']);
    //const pdfData = FS.readFile('myjobname.pdf', {encoding: 'binary'});
    
    //previewElement.src = URL.createObjectURL(new Blob([pdfData], {type: 'application/pdf'}));
};

var Module = 
{
    thisProgram : busytex, 

    noInitialRun : true,

    preRun : [(() =>
    {
        ENV.TEXMFDIST = '/texlive/texmf-dist:';
        ENV.FONTCONFIG_PATH = '/fontconfig';
        ENV.FONTCONFIG_FILE = 'texlive-fontconfig.conf';
    })],

    onRuntimeInitialized()
    {
        main(Module);
    },
    
    print(text) 
    {
        if (arguments.length > 1)
            text = Array.prototype.slice.call(arguments).join(' ');
        Module.setStatus('stdout: ' + text);
    },

    printErr(text)
    {
        if (arguments.length > 1)
            text = Array.prototype.slice.call(arguments).join(' ');
        Module.setStatus('stderr: ' + text);
    },
    
    setStatus(text)
    {
        statusElement.value += (this.statusPrefix || '') + text + '\n';
        statusElement.scrollTop = statusElement.scrollHeight;
    },
    
    monitorRunDependencies(left)
    {
        this.totalDependencies = Math.max(this.totalDependencies, left);
        Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
    },
    
    totalDependencies: 0,
};
Module.setStatus('Downloading Emscripten...');
window.onerror = () => { Module.statusPrefix = '[post-exception] ';};
</script>

</script>
<script async type="text/javascript" src="texlive.js"></script>
<script async type="text/javascript" src="busytex.js"></script>

</body></html>

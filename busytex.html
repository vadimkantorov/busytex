<html><head><title>busytex example</title></head><body style="width: 100%; height: 100%; overflow: hidden">
<div style="width: 98%; height: 5%;" >
<input type="checkbox" id="use_worker" name="use_worker"checked>
<label for="use_worker">Use worker</label>
<span id="time_elapsed" name="time_elapsed" style="float:right">0.00 sec</span>
<label for="time_elapsed" style="float:right">Time elapsed:</label>
</div>
<div><iframe style="width: 98%; height:25%" id="preview"></iframe></div>

<div><textarea style="width: 98%; height: 25%" id="tex">
\documentclass[11pt]{article}
\begin{document}
\title{My Article}
\author{Nobody Jr.}
\date{Today}
\maketitle
Blablabla said Nobody ~\cite{Nobody06}.
\bibliography{example}{}
\bibliographystyle{plain}
\end{document}
</textarea></div>
<div><textarea style="width: 98%; height: 15%" id="bib">
@misc{Nobody06,
   author = "Nobody Jr",
   title = "My Article",
   year = "2006" 
}
</textarea></div>

<div><textarea style="width: 98%; height: 20%" id="status"></textarea></div>
<div><button style="width: 98%; height: 10%; font-size: x-large" onclick="onclick_()">Compile</button></div> 

<script>

tic = 0;

if(document.getElementById('use_worker').checked)
{
    worker = new Worker('/busytex.worker.js');
}
else
{
    worker = 
    {
        pipeline : new Promise(function (resolve, reject)
        {
            let s = document.createElement('script');
            s.src = '/busytex.pipeline.js';
            s.onload = resolve;
            s.onerror = reject;
            self.document.head.appendChild(s);
        }).then(_ => Promise.resolve(new BusytexPipeline('/dist/busytex.wasm', '/dist/busytex.js', msg => worker.onmessage({data: {log : msg}}), BusytexDefaultLoader))),
        
        async postMessage(tex_bib)
        {
            const pipeline = await worker.pipeline;
            const pdf = await pipeline.compile(tex_bib.tex, tex_bib.bib);
            worker.onmessage({data : {pdf : pdf}});
        }
    }
}

worker.onmessage = e =>
{
    const {pdf, log} = e.data;
    if(pdf)
    {
        let previewElement = document.getElementById('preview');
        previewElement.src = URL.createObjectURL(new Blob([pdf], {type: 'application/pdf'}));

        let elapsedElement = document.getElementById('time_elapsed');
        elapsedElement.innerText = ((performance.now() - tic) / 1000).toFixed(2) + ' sec';
    }

    if(log)
    {
        let statusElement = document.getElementById('status');
        statusElement.value += log;
        statusElement.value += '\n';
        statusElement.scrollTop = statusElement.scrollHeight;
    }
}

async function onclick_()
{
    tic = performance.now();
    const tex = document.getElementById('tex').value, bib = document.getElementById('bib').value;
    worker.postMessage({tex : tex, bib :bib})
}

</script>


</body></html>

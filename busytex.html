<html><head><title>busytex example</title></head><body style="width: 100%; height: 100%; overflow: hidden">

<div><iframe style="width: 98%; height:30%" id="preview"></iframe></div>

<div><textarea style="width: 98%; height: 25%" id="tex">
\documentclass[11pt]{article}
\begin{document}
\title{My Article}
\author{Nobody Jr.}
\date{Today}
\maketitle
Blablabla said Nobody ~\cite{Nobody06}.
\bibliography{example}{}
\bibliographystyle{plain}
\end{document}
</textarea></div>
<div><textarea style="width: 98%; height: 15%" id="bib">
@misc{Nobody06,
   author = "Nobody Jr",
   title = "My Article",
   year = "2006" 
}
</textarea></div>

<div><textarea style="width: 98%; height: 20%" id="status"></textarea></div>
<div><button style="width: 98%; height: 10%; font-size: x-large" onclick="onclick_()">Compile</button></div> 

<!--<script src="/busytex.pipeline.js" type="text/javascript"></script>-->

<script>

const use_worker = false;
if(use_worker)
{
    worker = new Worker('/busytex.worker.js');
}
else
{
    var s = document.createElement('script');
    s.src = '/busytex.pipeline.js';
    s.type = 'text/javascript';
    s.async = false;
    document.getElementsByTagName('head')[0].appendChild(s);
    
    pipeline = new BusytexPipeline('/dist/busytex.wasm', '/dist/busytex.js', msg => worker.onmessage({data: {log : msg}}), BusytexDefaultLoader);
    worker = 
    {
        async postMessage(tex_bib)
        {
            const pdf = await pipeline.compile(tex_bib.tex, tex_bib.bib);
            worker.onmessage({data : {pdf : pdf}});
        }
    }
}

worker.onmessage = e =>
{
    const {pdf, log} = e.data;
    if(pdf)
    {
        let previewElement = document.getElementById('preview');
        previewElement.src = URL.createObjectURL(new Blob([pdf], {type: 'application/pdf'}));
    }

    if(log)
    {
        let statusElement = document.getElementById('status');
        statusElement.value += log;
        statusElement.value += '\n';
        statusElement.scrollTop = statusElement.scrollHeight;
    }
}

async function onclick_()
{
    const tex = document.getElementById('tex').value, bib = document.getElementById('bib').value;
    worker.postMessage({tex : tex, bib :bib})
}

</script>


</body></html>
